# Middleware (Introduction)

Middleware allows you to run code before a request is completed. Then, based on the incoming request, you can modify the response by rewriting, redirecting, modifying the request or response headers, or responding directly.

1. When a client (usually a web browser) makes a request to a web server, the server needs to process the request and generate a response. Middleware provides a mechanism to intercept the request and perform certain actions before it reaches the main application logic or route handler. This allows you to preprocess the request, validate data, authenticate users, or perform any other necessary tasks before the actual request handling takes place.
   For example, imagine a middleware that logs each incoming request along with the timestamp and the requested URL. This middleware will execute before the main application logic is invoked, ensuring that the request's information is recorded for monitoring or debugging purposes.
2. Middleware also grants you the ability to modify the response generated by the main application logic before it is sent back to the client. This means you can alter the response's content, headers, status code, or even redirect the response to a different URL.
   For example, a compression middleware might compress the response body to reduce its size and improve performance before sending it back to the client. Another example could be a security middleware that adds security-related headers to the response to enhance the application's security.
3. Middleware can perform various actions, including but not limited to:
   - Rewriting: Modifying the incoming request's URL or parameters before passing it to the main application logic. This could be useful for URL rewriting or routing purposes.
   - Redirecting: Middleware can check the request and decide to redirect the client to a different URL if necessary. For example, a URL redirection middleware could handle URL aliases or permanently redirect old URLs to new ones.
   - Modifying headers: Middleware can add, remove, or modify headers in both the incoming request and the outgoing response. This can be used for caching, CORS (Cross-Origin Resource Sharing) handling, or setting security-related headers.
   - Responding directly: In certain cases, middleware can bypass the main application logic altogether and generate a response directly. This is useful for implementing custom error handling, responding to specific routes, or returning cached responses.

## Middleware Example

1. Create next app

   ```cmd
   npx create-next-app@latest
   ```

2. Create `/`, `/about1` and `/about2` routes

   ```tsx
   /**
    * src/app/page.tsx
    */
   import Link from 'next/link';
   export default function Home() {
     return (
       <div className='mx-10'>
         <h1 className='my-10 text-lg font-bold'>Middleware</h1>
         <div className='mx-10'>
           <p className='text-base font-semibold'>Routes</p>
           <ul className='list-disc mt-3 px-10 space-y-2 text-blue-800'>
             <li>
               <Link href='/about1'>about1</Link>
             </li>
             <li>
               <Link href='/about2'>about2</Link>
             </li>
           </ul>
         </div>
       </div>
     );
   }
   ```

   ```tsx
   /**
    * src/app/about1/page.tsx
    */
   import Link from 'next/link';
   export default function Home() {
     return (
       <div className='mx-10'>
         <h1 className='my-10 text-lg font-bold'>Middleware</h1>
         <div className='mx-10'>
           <p className='text-base font-semibold'>About 01</p>
         </div>
       </div>
     );
   }
   ```

   ```tsx
   /**
    * src/app/about2/page.tsx
    */
   import Link from 'next/link';
   export default function Home() {
     return (
       <div className='mx-10'>
         <h1 className='my-10 text-lg font-bold'>Middleware</h1>
         <div className='mx-10'>
           <p className='text-base font-semibold'>About 02</p>
         </div>
       </div>
     );
   }
   ```

3. Use the file `middleware.ts` in the root of your project to define Middleware.

    ```ts
    /**
     * src/app/about2/page.tsx
    */
    import { NextResponse } from 'next/server';
    import type { NextRequest } from 'next/server';
    // middleware function to be executed
    // will be executed for all mentioned routes
    // in this example we are are just rerouting
    export function middleware(request: NextRequest) {
      console.log('consoled from middleware');
      return NextResponse.redirect(new URL('/about2', request.url));
    }
    // Define routes for which we need to execute the middleware function
    export const config = {
      matcher: '/about1',
    };
    ```

4. Now try accessing `/about1`, you will always be re-directed to `/about2`